@model RestaurantManagementSystem.Models.CashClosingReportViewModel
@{
    ViewData["Title"] = "Cash Closing Report";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="container-fluid">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="mb-1">
                <i class="fas fa-cash-register text-primary me-2"></i>
                Cash Closing Report
            </h2>
            <p class="text-muted mb-0">Comprehensive cash reconciliation analysis</p>
        </div>
        <div>
            <button onclick="window.print()" class="btn btn-outline-primary">
                <i class="fas fa-print me-2"></i>Print Report
            </button>
        </div>
    </div>

    <!-- Filters -->
    <div class="card mb-4 print-hide">
        <div class="card-header bg-primary text-white">
            <i class="fas fa-filter me-2"></i>Report Filters
        </div>
        <div class="card-body">
            <form asp-action="CashClosing" method="post">
                <div class="row g-3">
                    <div class="col-md-3">
                        <label asp-for="Filters.StartDate" class="form-label">Start Date</label>
                        <input asp-for="Filters.StartDate" type="date" class="form-control" required />
                        <span asp-validation-for="Filters.StartDate" class="text-danger"></span>
                    </div>
                    <div class="col-md-3">
                        <label asp-for="Filters.EndDate" class="form-label">End Date</label>
                        <input asp-for="Filters.EndDate" type="date" class="form-control" required />
                        <span asp-validation-for="Filters.EndDate" class="text-danger"></span>
                    </div>
                    <div class="col-md-4">
                        <label asp-for="Filters.CashierId" class="form-label">Cashier (Optional)</label>
                        <select asp-for="Filters.CashierId" class="form-select">
                            <option value="">All Cashiers</option>
                            @if (ViewBag.Cashiers != null)
                            {
                                foreach (var cashier in (List<(int Id, string Name)>)ViewBag.Cashiers)
                                {
                                    <option value="@cashier.Id">@cashier.Name</option>
                                }
                            }
                        </select>
                    </div>
                    <div class="col-md-2 d-flex align-items-end">
                        <button type="submit" class="btn btn-primary w-100">
                            <i class="fas fa-search me-2"></i>Generate Report
                        </button>
                    </div>
                </div>
                @if (ViewData.ModelState.ErrorCount > 0)
                {
                    <div class="alert alert-danger mt-3 mb-0">
                        @Html.ValidationSummary(false, "", new { @class = "mb-0" })
                    </div>
                }
            </form>
        </div>
    </div>

    <!-- Summary Statistics Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <p class="text-muted mb-1 small">Total Days</p>
                            <h4 class="mb-0 fw-bold">@Model.Summary.TotalDays</h4>
                        </div>
                        <div class="bg-primary bg-opacity-10 rounded-circle p-3">
                            <i class="fas fa-calendar-alt text-primary fa-lg"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <p class="text-muted mb-1 small">Total Cashiers</p>
                            <h4 class="mb-0 fw-bold">@Model.Summary.TotalCashiers</h4>
                        </div>
                        <div class="bg-info bg-opacity-10 rounded-circle p-3">
                            <i class="fas fa-users text-info fa-lg"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <p class="text-muted mb-1 small">Total Cash Collected</p>
                            <h4 class="mb-0 fw-bold text-success">₹@Model.Summary.TotalSystemAmount.ToString("N2")</h4>
                        </div>
                        <div class="bg-success bg-opacity-10 rounded-circle p-3">
                            <i class="fas fa-rupee-sign text-success fa-lg"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <p class="text-muted mb-1 small">Total Variance</p>
                            <h4 class="mb-0 fw-bold @(Model.Summary.TotalVariance >= 0 ? "text-success" : "text-danger")">
                                ₹@Math.Abs(Model.Summary.TotalVariance).ToString("N2")
                                @(Model.Summary.TotalVariance >= 0 ? "Over" : "Short")
                            </h4>
                        </div>
                        <div class="@(Model.Summary.TotalVariance >= 0 ? "bg-success" : "bg-danger") bg-opacity-10 rounded-circle p-3">
                            <i class="fas fa-balance-scale @(Model.Summary.TotalVariance >= 0 ? "text-success" : "text-danger") fa-lg"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Additional Summary Cards -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body">
                    <h6 class="text-muted mb-3">Cash Summary</h6>
                    <div class="row g-2">
                        <div class="col-6">
                            <small class="text-muted">Opening Float:</small>
                            <div class="fw-bold">₹@Model.Summary.TotalOpeningFloat.ToString("N2")</div>
                        </div>
                        <div class="col-6">
                            <small class="text-muted">System Amount:</small>
                            <div class="fw-bold">₹@Model.Summary.TotalSystemAmount.ToString("N2")</div>
                        </div>
                        <div class="col-6">
                            <small class="text-muted">Expected:</small>
                            <div class="fw-bold">₹@Model.Summary.TotalExpectedCash.ToString("N2")</div>
                        </div>
                        <div class="col-6">
                            <small class="text-muted">Declared:</small>
                            <div class="fw-bold">₹@Model.Summary.TotalDeclaredAmount.ToString("N2")</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body">
                    <h6 class="text-muted mb-3">Variance Breakdown</h6>
                    <div class="row g-2">
                        <div class="col-6">
                            <small class="text-muted">Cash Over:</small>
                            <div class="fw-bold text-success">₹@Model.Summary.TotalCashOver.ToString("N2")</div>
                        </div>
                        <div class="col-6">
                            <small class="text-muted">Cash Short:</small>
                            <div class="fw-bold text-danger">₹@Model.Summary.TotalCashShort.ToString("N2")</div>
                        </div>
                        <div class="col-6">
                            <small class="text-muted">Net Variance:</small>
                            <div class="fw-bold">₹@Model.Summary.TotalVariance.ToString("N2")</div>
                        </div>
                        <div class="col-6">
                            <small class="text-muted">Variance %:</small>
                            <div class="fw-bold">@Model.Summary.VariancePercentage%</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body">
                    <h6 class="text-muted mb-3">Status Summary</h6>
                    <div class="row g-2">
                        <div class="col-6">
                            <small class="text-muted">Approved:</small>
                            <div class="fw-bold text-success">@Model.Summary.ApprovedCount</div>
                        </div>
                        <div class="col-6">
                            <small class="text-muted">Pending:</small>
                            <div class="fw-bold text-warning">@Model.Summary.PendingApprovalCount</div>
                        </div>
                        <div class="col-6">
                            <small class="text-muted">Locked:</small>
                            <div class="fw-bold text-secondary">@Model.Summary.LockedCount</div>
                        </div>
                        <div class="col-6">
                            <small class="text-muted">Total Records:</small>
                            <div class="fw-bold">@Model.DetailRecords.Count</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Daily Summary Table -->
    @if (Model.DailySummaries.Any())
    {
        <div class="card mb-4">
            <div class="card-header bg-light">
                <h5 class="mb-0"><i class="fas fa-calendar-day me-2"></i>Daily Summary</h5>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Date</th>
                                <th class="text-center">Cashiers</th>
                                <th class="text-end">Opening Float</th>
                                <th class="text-end">System Amount</th>
                                <th class="text-end">Expected</th>
                                <th class="text-end">Declared</th>
                                <th class="text-end">Variance</th>
                                <th class="text-center">Locked</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var day in Model.DailySummaries)
                            {
                                <tr>
                                    <td>
                                        <strong>@day.BusinessDate.ToString("ddd, dd MMM yyyy")</strong>
                                    </td>
                                    <td class="text-center">
                                        <span class="badge bg-info">@day.CashierCount</span>
                                    </td>
                                    <td class="text-end">₹@day.DayOpeningFloat.ToString("N2")</td>
                                    <td class="text-end">₹@day.DaySystemAmount.ToString("N2")</td>
                                    <td class="text-end fw-bold">₹@day.DayExpectedCash.ToString("N2")</td>
                                    <td class="text-end">₹@day.DayDeclaredAmount.ToString("N2")</td>
                                    <td class="text-end">
                                        <span class="@(day.DayVariance >= 0 ? "text-success" : "text-danger") fw-bold">
                                            ₹@Math.Abs(day.DayVariance).ToString("N2")
                                            @(day.DayVariance >= 0 ? "Over" : "Short")
                                        </span>
                                    </td>
                                    <td class="text-center">
                                        @if (day.IsLocked)
                                        {
                                            <span class="badge bg-secondary">
                                                <i class="fas fa-lock me-1"></i>Yes
                                            </span>
                                        }
                                        else
                                        {
                                            <span class="badge bg-warning text-dark">
                                                <i class="fas fa-unlock me-1"></i>No
                                            </span>
                                        }
                                    </td>
                                </tr>
                            }
                        </tbody>
                        <tfoot class="table-light">
                            <tr class="fw-bold">
                                <td>TOTAL</td>
                                <td class="text-center">-</td>
                                <td class="text-end">₹@Model.DailySummaries.Sum(d => d.DayOpeningFloat).ToString("N2")</td>
                                <td class="text-end">₹@Model.DailySummaries.Sum(d => d.DaySystemAmount).ToString("N2")</td>
                                <td class="text-end">₹@Model.DailySummaries.Sum(d => d.DayExpectedCash).ToString("N2")</td>
                                <td class="text-end">₹@Model.DailySummaries.Sum(d => d.DayDeclaredAmount).ToString("N2")</td>
                                <td class="text-end">₹@Model.DailySummaries.Sum(d => d.DayVariance).ToString("N2")</td>
                                <td class="text-center">-</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>
    }

    <!-- Detailed Records Table -->
    @if (Model.DetailRecords.Any())
    {
        <div class="card mb-4">
            <div class="card-header bg-light">
                <h5 class="mb-0"><i class="fas fa-list-alt me-2"></i>Detailed Records</h5>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-striped table-hover mb-0">
                        <thead class="table-dark">
                            <tr>
                                <th>Date</th>
                                <th>Cashier</th>
                                <th class="text-end">Opening</th>
                                <th class="text-end">System</th>
                                <th class="text-end">Expected</th>
                                <th class="text-end">Declared</th>
                                <th class="text-end">Variance</th>
                                <th class="text-center">Type</th>
                                <th class="text-center">Status</th>
                                <th class="text-center">Approved By</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var record in Model.DetailRecords)
                            {
                                <tr>
                                    <td>@record.BusinessDate.ToString("dd/MM/yyyy")</td>
                                    <td>
                                        <strong>@record.CashierName</strong>
                                    </td>
                                    <td class="text-end">₹@record.OpeningFloat.ToString("N2")</td>
                                    <td class="text-end">₹@record.SystemAmount.ToString("N2")</td>
                                    <td class="text-end fw-bold">₹@record.ExpectedCash.ToString("N2")</td>
                                    <td class="text-end">₹@record.DeclaredAmount.ToString("N2")</td>
                                    <td class="text-end">
                                        <span class="@record.VarianceTypeClass fw-bold">
                                            ₹@Math.Abs(record.Variance).ToString("N2")
                                        </span>
                                    </td>
                                    <td class="text-center">
                                        <span class="@record.VarianceTypeClass small">@record.VarianceType</span>
                                    </td>
                                    <td class="text-center">
                                        <span class="@record.StatusBadgeClass">@record.Status</span>
                                    </td>
                                    <td class="text-center">
                                        @if (!string.IsNullOrEmpty(record.ApprovedBy))
                                        {
                                            <span class="text-success">
                                                <i class="fas fa-check-circle me-1"></i>@record.ApprovedBy
                                            </span>
                                        }
                                        else
                                        {
                                            <span class="text-muted">-</span>
                                        }
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    }

    <!-- Cashier Performance Table -->
    @if (Model.CashierPerformance.Any())
    {
        <div class="card mb-4">
            <div class="card-header bg-light">
                <h5 class="mb-0"><i class="fas fa-chart-line me-2"></i>Cashier Performance</h5>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Cashier</th>
                                <th class="text-center">Days Worked</th>
                                <th class="text-end">Total Cash</th>
                                <th class="text-end">Avg Variance</th>
                                <th class="text-end">Best</th>
                                <th class="text-end">Worst</th>
                                <th class="text-center">Within Tolerance</th>
                                <th class="text-center">Performance</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var perf in Model.CashierPerformance)
                            {
                                <tr>
                                    <td><strong>@perf.CashierName</strong></td>
                                    <td class="text-center">@perf.TotalDaysWorked</td>
                                    <td class="text-end">₹@perf.TotalCashCollected.ToString("N2")</td>
                                    <td class="text-end">₹@perf.AverageVariance.ToString("N2")</td>
                                    <td class="text-end text-success">₹@perf.BestVariance.ToString("N2")</td>
                                    <td class="text-end text-danger">₹@perf.WorstVariance.ToString("N2")</td>
                                    <td class="text-center">
                                        <span class="badge bg-info">
                                            @perf.DaysWithinTolerance / @perf.TotalDaysWorked
                                        </span>
                                        <small class="d-block mt-1">(@perf.TolerancePercentage%)</small>
                                    </td>
                                    <td class="text-center">
                                        <span class="@perf.PerformanceClass">
                                            <i class="fas fa-star me-1"></i>@perf.PerformanceRating
                                        </span>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    }

    <!-- Day Lock Audit -->
    @if (Model.DayLockAudits.Any())
    {
        <div class="card mb-4 print-avoid-break">
            <div class="card-header bg-light">
                <h5 class="mb-0"><i class="fas fa-history me-2"></i>Day Lock Audit Trail</h5>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-sm mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Date</th>
                                <th>Locked By</th>
                                <th>Lock Time</th>
                                <th>Status</th>
                                <th>Remarks</th>
                                <th>Reopened By</th>
                                <th>Reopen Reason</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var audit in Model.DayLockAudits)
                            {
                                <tr>
                                    <td>@audit.BusinessDate.ToString("dd/MM/yyyy")</td>
                                    <td>@audit.LockedBy</td>
                                    <td>@audit.LockTime.ToString("dd/MM/yyyy HH:mm")</td>
                                    <td><span class="@audit.StatusBadgeClass">@audit.Status</span></td>
                                    <td>@(audit.Remarks ?? "-")</td>
                                    <td>@(audit.ReopenedBy ?? "-")</td>
                                    <td>@(audit.ReopenReason ?? "-")</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    }

    @if (!Model.DetailRecords.Any())
    {
        <div class="card">
            <div class="card-body text-center py-5">
                <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                <h5 class="text-muted">No Data Available</h5>
                <p class="text-muted">No cash closing records found for the selected date range.</p>
            </div>
        </div>
    }
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <style>
        @@media print {
            .print-hide {
                display: none !important;
            }
            .card {
                border: 1px solid #dee2e6 !important;
                page-break-inside: avoid;
            }
            .print-avoid-break {
                page-break-inside: avoid;
            }
        }
    </style>
}
