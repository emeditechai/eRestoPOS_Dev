@model RestaurantManagementSystem.Models.CustomerReportViewModel

@{
    ViewData["Title"] = "Customer Reports";
}

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fas fa-users me-2"></i>Customer Reports</h2>
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a asp-controller="Home" asp-action="Index">Home</a></li>
                        <li class="breadcrumb-item active">Reports</li>
                        <li class="breadcrumb-item active">Customers</li>
                    </ol>
                </nav>
            </div>
        </div>
    </div>

    <form method="post" asp-action="Customers" class="row g-3 align-items-end mb-4">
        <div class="col-auto">
            <label asp-for="Filter.From" class="form-label">From</label>
            <input asp-for="Filter.From" class="form-control" />
        </div>
        <div class="col-auto">
            <label asp-for="Filter.To" class="form-label">To</label>
            <input asp-for="Filter.To" class="form-control" />
        </div>
        <div class="col-auto">
            <button type="submit" class="btn btn-primary">Run Report</button>
        </div>
    </form>

    <style>
        .report-tile { border-radius: 8px; color: #fff; min-height: 150px; display:block; }
        .report-tile .tile-content { height:100%; }
        .report-tile h2 { font-weight:700; }
        .tile-blue { background: linear-gradient(135deg,#4f93ff 0%,#2b6de9 100%); }
        .tile-green { background: linear-gradient(135deg,#2ad399 0%,#0fb07a 100%); }
        .tile-purple { background: linear-gradient(135deg,#9b7bff 0%,#6a4bff 100%); }
        /* table highlight */
        .table.table-sm tbody tr:hover { background-color: rgba(0,0,0,0.03); }
    @@media (max-width: 767px) { .report-tile { min-height:120px; } }
    </style>

    <div class="row">
        <div class="col-md-4">
            <div class="report-tile tile-blue mb-3">
                <div class="tile-content d-flex flex-column justify-content-center align-items-start p-3">
                    <div class="d-flex w-100 justify-content-between align-items-start">
                        <div>
                            <h6 class="text-uppercase text-muted mb-1">Total Customers</h6>
                            <h2 class="mb-0">@Model.Summary.TotalCustomers</h2>
                            <small class="text-light">New: @Model.Summary.NewCustomers &middot; Returning: @Model.Summary.ReturningCustomers</small>
                        </div>
                        <div style="width:90px; height:48px;"><canvas id="customersSparkline"></canvas></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="report-tile tile-purple mb-3">
                <div class="tile-content d-flex flex-column justify-content-center align-items-start p-3">
                    <div class="d-flex w-100 justify-content-between align-items-start">
                        <div>
                            <h6 class="text-uppercase text-muted mb-1">Avg Visits</h6>
                            <h2 class="mb-0">@Model.Summary.AverageVisitsPerCustomer</h2>
                            <small class="text-light">Visits per customer (avg)</small>
                        </div>
                        <div style="width:90px; height:48px;"><canvas id="visitsSparkline"></canvas></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="report-tile tile-green mb-3">
                <div class="tile-content d-flex flex-column justify-content-center align-items-start p-3">
                    <div class="d-flex w-100 justify-content-between align-items-start">
                        <div>
                            <h6 class="text-uppercase text-muted mb-1">Total Revenue</h6>
                            <h2 class="mb-0">@Model.Summary.TotalRevenue.ToString("C")</h2>
                            <small class="text-light">Revenue across selected period</small>
                        </div>
                        <div style="width:90px; height:48px;"><canvas id="revenueSparkline"></canvas></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row mt-3">
        <div class="col-lg-6">
            <div class="card mb-3">
                <div class="card-header">Top Customers</div>
                <div class="card-body">
                    <table class="table table-sm">
                        <thead>
                            <tr><th>Name</th><th>Phone</th><th>Visits</th><th>Revenue</th><th>LTV</th></tr>
                        </thead>
                        <tbody>
                            @foreach (var c in Model.TopCustomers)
                            {
                                <tr>
                                    <td>@c.Name</td>
                                    <td>@c.Phone</td>
                                    <td>@c.Visits</td>
                                    <td>@c.Revenue.ToString("C")</td>
                                    <td>@c.LTV.ToString("C")</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        <div class="col-lg-6">
            <div class="card mb-3">
                <div class="card-header">Visit Frequency</div>
                <div class="card-body">
                    <canvas id="visitFrequencyChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div class="row mt-3">
        <div class="col-lg-6">
            <div class="card mb-3">
                <div class="card-header">Loyalty Buckets</div>
                <div class="card-body">
                    <ul>
                        @foreach (var b in Model.LoyaltyStats)
                        {
                            <li>@b.Bucket: @b.CustomerCount</li>
                        }
                    </ul>
                </div>
            </div>
        </div>
        <div class="col-lg-6">
            <div class="card mb-3">
                <div class="card-header">Demographics</div>
                <div class="card-body">
                    <table class="table table-sm">
                        <thead><tr><th>Category</th><th>Count</th></tr></thead>
                        <tbody>
                            @foreach (var d in Model.Demographics)
                            {
                                <tr><td>@d.Category</td><td>@d.Count</td></tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        (function(){
            var visits = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.VisitFrequencies.Select(x=> new { x.Period, x.Visits, x.Revenue })));

            // main visit frequency chart
            var ctx = document.getElementById('visitFrequencyChart');
            if (ctx) {
                var vctx = ctx.getContext('2d');
                var labels = visits.map(v=>v.Period);
                var data = visits.map(v=>v.Visits);
                new Chart(vctx, {
                    type: 'line',
                    data: { labels: labels, datasets: [{ label: 'Visits', data: data, borderColor: '#007bff', backgroundColor: 'rgba(0,123,255,0.08)', fill:true }] },
                    options: { responsive:true, plugins:{legend:{display:false}}, scales:{y:{beginAtZero:true}} }
                });
            }

            // small sparklines for tiles (customers, visits, revenue)
            function createSparkline(canvasId, dataPoints, color) {
                var el = document.getElementById(canvasId);
                if (!el) return;
                new Chart(el.getContext('2d'), {
                    type: 'line',
                    data: { labels: dataPoints.map((_,i)=>i), datasets: [{ data: dataPoints, borderColor: color, backgroundColor: color, fill:false, tension:0.3 }] },
                    options: { responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}, elements:{point:{radius:0}}, scales:{x:{display:false}, y:{display:false}} }
                });
            }

            var visitVals = visits.map(v=>v.Visits);
            var revenueVals = visits.map(v=>parseFloat(v.Revenue || 0));
            // customers sparkline: if VisitFrequencies not containing distinct customers, use visits as proxy
            createSparkline('customersSparkline', visitVals, '#ffffff');
            createSparkline('visitsSparkline', visitVals, '#ffffff');
            createSparkline('revenueSparkline', revenueVals, '#ffffff');
        })();
    </script>
}