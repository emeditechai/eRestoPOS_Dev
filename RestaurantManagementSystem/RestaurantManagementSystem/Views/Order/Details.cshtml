@model OrderViewModel
@{
    ViewData["Title"] = "Order Details";
}
@section Styles {
  <style>
    /* Ensure top nav dropdowns appear above sticky side panels on order details page */
    .navbar { z-index: 2000 !important; }
    #orderDetailsApp .sticky-top { z-index: 100; }
    /* Defensive: allow dropdown menus to overflow visible area */
    .navbar .dropdown-menu { position: absolute; }
    /* Disabled anchor-style buttons (payment link) */
    .btn-disabled { pointer-events: none; opacity: 0.65; cursor: default !important; }
    /* Page watermark when order fully paid */
    .page-watermark {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) rotate(-18deg);
      pointer-events: none;
      user-select: none;
      z-index: 50; /* lower so it does not fully obscure UI controls */
      -webkit-print-color-adjust: exact;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0.55; /* overall subtle opacity */
    }
    .page-watermark .watermark-circle {
      width: 220px; /* smaller, less intrusive */
      height: 220px;
      border-radius: 50%;
      border: 6px solid rgba(220,20,60,0.12); /* very soft red ring */
      background: rgba(255,255,255,0.0);
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 12px rgba(0,0,0,0.03) inset;
    }
    .page-watermark .watermark-circle span {
      display: block;
      color: rgba(220,20,60,0.35); /* faint red text */
      font-size: 2.6rem;
      font-weight: 800;
      letter-spacing: 0.08em;
      transform: translateY(4px); /* slight vertical adjustment */
    }
    @@media (max-width: 768px) {
      .page-watermark .watermark-circle { width: 160px; height: 160px; border-width: 5px; }
      .page-watermark .watermark-circle span { font-size: 1.8rem; }
      .page-watermark { top: 50%; }
    }
    /* Hide watermark when printing header/footer areas might overlap; keep visible on print */
    @@media print {
      /* For print, keep it visible but still subtle */
      .page-watermark .watermark-circle { width: 320px; height: 320px; border-width: 10px; }
      .page-watermark .watermark-circle span { font-size: 4.2rem; color: rgba(200,0,0,0.45); }
    }
    /* Deep blue color for Order # */
    .order-number-text {
      color: #003d82;
      font-weight: 600;
    }
    /* Colorful Order Summary styling */
    .order-summary-card .card-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      font-weight: 600;
    }
    .order-summary-card .card-body {
      background: linear-gradient(to bottom, #f8f9ff 0%, #ffffff 100%);
    }
    .order-summary-card dt {
      color: #5a67d8;
      font-weight: 600;
    }
    .order-summary-card dd {
      color: #2d3748;
      font-weight: 500;
    }
  </style>
}
@{
  var isFullyPaid = Model.IsFullyPaid;
  var paymentClass = "btn btn-sm btn-success" + (isFullyPaid ? " btn-disabled" : "");
  var isBarOrder = ViewBag.IsBarOrder ?? false;
  var fireButtonLabel = isBarOrder ? "Fire To Bar" : "Fire To Kitchen";
  var fireButtonIcon = isBarOrder ? "fa-cocktail" : "fa-fire";
  var kotPrintLabel = isBarOrder ? "BOT Print" : "KOT Print";
}
<div class="container-fluid py-3 position-relative" id="orderDetailsApp" data-order-id="@Model.Id" data-is-fully-paid="@isFullyPaid.ToString().ToLower()"  data-is-bar-order="@isBarOrder.ToString().ToLower()">
  @if (isFullyPaid)
  {
    <div class="page-watermark" aria-hidden="true">
      <div class="watermark-circle"><span>PAID</span></div>
    </div>
  }
  <div class="row g-3">
    <div class="col-lg-8 col-12">
      <div class="d-flex flex-wrap align-items-center gap-2 mb-2">
        <form id="orderItemAddForm" class="row row-cols-auto g-2 align-items-end flex-grow-1" autocomplete="off">
          @Html.AntiForgeryToken()
          <input type="hidden" id="orderId" value="@Model.Id" />
            <div class="col" style="min-width:200px;">
            <label for="menuItemGroupSelect" class="form-label small mb-1 fw-semibold">Item Group</label>
            <select id="menuItemGroupSelect" class="form-select form-select-sm" disabled>
                @if (Model.MenuItemGroups != null && Model.MenuItemGroups.Any())
                {
                    foreach (var g in Model.MenuItemGroups)
                    {
                        if (g.ID == Model.SelectedMenuItemGroupId)
                        {
                            <option value="@g.ID" selected>@g.ItemGroup</option>
                        }
                        else
                        {
                            <option value="@g.ID">@g.ItemGroup</option>
                        }
                    }
                }
                else
                {
                    <option value="1" selected>Default</option>
                }
            </select>
          </div>
            <div class="col flex-grow-1" style="min-width:200px;">
            <label for="menuItemInput" class="form-label small mb-1 fw-semibold">Menu Item</label>
            <input list="menuItems" id="menuItemInput" class="form-control form-control-sm" placeholder="Search menu (name)..." required disabled="@(isFullyPaid ? "disabled" : null)" />
            <datalist id="menuItems">
                @foreach (var mi in Model.AvailableMenuItems)
                {
                  <option value="@mi.Name" data-id="@mi.Id" data-price="@mi.Price.ToString("F2")" data-plu="@mi.PLUCode">@mi.PLUCode - @mi.Name (₹@mi.Price.ToString("F2"))</option>
                }
            </datalist>
          </div>
          <div class="col">
            <label for="menuItemQty" class="form-label small mb-1 fw-semibold">Qty</label>
            <input type="number" id="menuItemQty" class="form-control form-control-sm" min="1" value="1" required />
          </div>
            <div class="col">
              <button type="submit" class="btn btn-sm btn-primary" id="addItemBtn" disabled="@(isFullyPaid ? "disabled" : null)"><i class="fas fa-plus"></i> Add</button>
            </div>
        </form>
        <div class="ms-auto d-flex gap-2">
          <button type="button" id="fireItemsBtn" class="btn btn-sm btn-outline-warning" data-bs-toggle="modal" data-bs-target="#fireItemsModal"><i class="fas @fireButtonIcon"></i> @fireButtonLabel</button>
          @{ var hasKOT = Model.KitchenTickets != null && Model.KitchenTickets.Any(); }
          <a asp-action="KOTBill" asp-route-id="@Model.Id" class="btn btn-sm btn-outline-info @(hasKOT ? "" : "btn-disabled")" title="@kotPrintLabel" target="_blank" rel="noopener noreferrer" aria-disabled="@(hasKOT? "false" : "true")"> <i class="fas fa-print"></i> @kotPrintLabel</a>
          @if (ViewBag.IsBarOrder == true)
          {
            <a asp-controller="BOT" asp-action="BarOrderDashboard" class="btn btn-sm btn-outline-secondary"><i class="fas fa-arrow-left"></i> Back</a>
          }
          else
          {
            <a asp-action="Dashboard" class="btn btn-sm btn-outline-secondary"><i class="fas fa-arrow-left"></i> Back</a>
          }
            <a asp-controller="Payment" asp-action="Index" asp-route-id="@Model.Id" asp-route-fromBar="@(isBarOrder ? "true" : null)" class="@paymentClass" aria-disabled="@(isFullyPaid ? "true" : null)" tabindex="@(isFullyPaid ? "-1" : null)"><i class="fas fa-credit-card"></i> Payment</a>
        </div>
      </div>
      <div class="card shadow-sm mb-3">
        <div class="card-header d-flex justify-content-between align-items-center py-2">
          <div class="small"><strong class="order-number-text">Order #:</strong> <span class="order-number-text">@Model.OrderNumber</span> <span class="badge bg-secondary ms-2">@Model.StatusDisplay</span></div>
          <button id="saveOrderBtn" class="btn btn-sm btn-primary"><i class="fas fa-save"></i> Save</button>
        </div>
        <div class="card-body p-0">
                    <div class="table-responsive">
            <table class="table table-sm table-hover align-middle mb-0" id="orderItemsTable">
          <thead style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
            <tr>
              <th style="width:50px"><input type="checkbox" id="selectAllFire" /></th>
              <th>Item</th>
              <th style="width:90px" class="text-center">Qty</th>
              <th style="width:110px" class="text-end">Unit</th>
              <th style="width:120px" class="text-end">Subtotal</th>
              <th style="width:110px">Status</th>
              <th style="width:70px"></th>
            </tr>
          </thead>
          <tbody id="orderItemsBody">
            @foreach (var it in Model.Items.Where(i=> i.Status != 5))
            {
              <tr data-order-item-id="@it.Id" data-menu-item-id="@it.MenuItemId" class="existing-item-row">
                <td class="text-center"><input type="checkbox" class="fire-select" value="@it.Id" /></td>
                <td>
                  <div class="fw-semibold">@it.MenuItemName</div>
                  <div class="d-flex gap-1 mt-1">
                    <input type="text" class="form-control form-control-sm item-note" value="@it.SpecialInstructions" placeholder="Note" disabled />
                    <button type="button" class="btn btn-sm btn-outline-secondary edit-row @(isFullyPaid ? "d-none" : "")" title="Edit"><i class="fas fa-edit"></i></button>
                    <button type="button" class="btn btn-sm btn-outline-success save-row d-none @(isFullyPaid ? "d-none" : "")" title="Apply"><i class="fas fa-check"></i></button>
                    <button type="button" class="btn btn-sm btn-outline-warning cancel-row d-none @(isFullyPaid ? "d-none" : "")" title="Cancel"><i class="fas fa-undo"></i></button>
                  </div>
                </td>
                <td class="text-center"><input type="number" class="form-control form-control-sm item-qty" value="@it.Quantity" min="1" disabled /></td>
                <td class="text-end">₹@it.UnitPrice.ToString("F2")</td>
                <td class="text-end subtotal-cell">₹@it.Subtotal.ToString("F2")</td>
                <td><span class="badge bg-@(it.Status==0?"primary":it.Status==1?"warning text-dark":it.Status==2?"info":it.Status==3?"success":"secondary")">@it.StatusDisplay</span></td>
                <td class="text-end"><button type="button" class="btn btn-outline-danger btn-sm remove-existing @(isFullyPaid ? "d-none" : "")"><i class="fas fa-times"></i></button></td>
              </tr>
            }
          </tbody>
          <tfoot class="table-light">
            <tr>
              <td colspan="4" class="text-end fw-semibold">Subtotal:</td>
              <td colspan="3" class="text-end" id="orderSubtotalCell">₹@((Model.Items.Where(i=>i.Status!=5).Sum(i=>i.Subtotal)).ToString("F2"))</td>
            </tr>
            <tr>
              <td colspan="4" class="text-end">GST (@Model.GSTPercentage.ToString("F2")%):</td>
              <td colspan="3" class="text-end" id="orderTaxCell">₹@Model.TaxAmount.ToString("F2")</td>
            </tr>
            <tr>
              <td colspan="4" class="text-end small text-muted">&nbsp;&nbsp;CGST (@( (Model.GSTPercentage/2).ToString("F2") )%):</td>
              <td colspan="3" class="text-end small text-muted">₹@Model.CGSTAmount.ToString("F2")</td>
            </tr>
            <tr>
              <td colspan="4" class="text-end small text-muted">&nbsp;&nbsp;SGST (@( (Model.GSTPercentage/2).ToString("F2") )%):</td>
              <td colspan="3" class="text-end small text-muted">₹@Model.SGSTAmount.ToString("F2")</td>
            </tr>
            <tr>
              <td colspan="4" class="text-end fw-semibold">Total:</td>
              <td colspan="3" class="text-end fw-bold" id="orderTotalCell">₹@((Model.Items.Where(i=>i.Status!=5).Sum(i=>i.Subtotal)+Model.TaxAmount+Model.TipAmount-Model.DiscountAmount).ToString("F2"))</td>
            </tr>
          </tfoot>
            </table>
          </div>
        </div>
      </div>
    </div>
    <div class="col-lg-4 col-12">
      <div class="sticky-top" style="top:1rem;">
        <div class="card mb-3 shadow-sm order-summary-card">
          <div class="card-header py-2"><i class="fas fa-info-circle me-1"></i> Order Summary</div>
          <div class="card-body small">
            <dl class="row mb-0">
              <dt class="col-5">Customer</dt><dd class="col-7">@(!string.IsNullOrEmpty(Model.CustomerName)?Model.CustomerName: (string.IsNullOrEmpty(Model.GuestName)?"—":Model.GuestName))</dd>
              <dt class="col-5">Phone</dt><dd class="col-7">@(!string.IsNullOrEmpty(Model.CustomerPhone)?Model.CustomerPhone:"—")</dd>
              <dt class="col-5">Table</dt><dd class="col-7">@(!string.IsNullOrEmpty(Model.TableName)?Model.TableName:"—")</dd>
              <dt class="col-5">Server</dt><dd class="col-7">@(!string.IsNullOrEmpty(Model.ServerName)?Model.ServerName:"—")</dd>
              <dt class="col-5">Type</dt><dd class="col-7">@Model.OrderTypeDisplay</dd>
              <dt class="col-5">Created</dt><dd class="col-7">@Model.CreatedAt.ToString("g")</dd>
            </dl>
          </div>
        </div>
        <div class="card mb-3 shadow-sm" style="border-left: 4px solid #10b981;">
          <div class="card-header py-2" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white;"><i class="fas fa-sticky-note me-1"></i> Order Note</div>
          <div class="card-body small">
            @if(!string.IsNullOrWhiteSpace(Model.SpecialInstructions)){
              <div class="text-muted">@Model.SpecialInstructions</div>
            } else { <div class="text-muted fst-italic">No note provided.</div> }
          </div>
        </div>
        <div class="card shadow-sm" style="border-left: 4px solid #f59e0b;">
          <div class="card-header py-2" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white;"><i class="fas fa-receipt me-1"></i> Totals</div>
          <div class="card-body p-2">
            <table class="table table-sm mb-0">
              <tbody class="small">
                <tr><td class="text-muted">Subtotal</td><td class="text-end" id="orderSubtotalCell">₹@Model.Subtotal.ToString("F2")</td></tr>
                <tr><td class="text-muted">GST (@Model.GSTPercentage.ToString("F2")%)</td><td class="text-end" id="orderTaxCell">₹@Model.TaxAmount.ToString("F2")</td></tr>
                <tr><td class="text-muted small ps-3">CGST (@( (Model.GSTPercentage/2).ToString("F2") )%)</td><td class="text-end small">₹@Model.CGSTAmount.ToString("F2")</td></tr>
                <tr><td class="text-muted small ps-3">SGST (@( (Model.GSTPercentage/2).ToString("F2") )%)</td><td class="text-end small">₹@Model.SGSTAmount.ToString("F2")</td></tr>
                <tr><td class="text-muted">Discount</td><td class="text-end">₹@Model.DiscountAmount.ToString("F2")</td></tr>
                <tr class="table-light"><th>Total</th><th class="text-end" id="orderTotalCell">₹@Model.TotalAmount.ToString("F2")</th></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
  @if (Model.Items.Any(i=>i.Status==0))
  {
    <div class="modal fade" id="fireItemsModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <form id="fireItemsForm" asp-action="FireItems" method="post">
            @Html.AntiForgeryToken()
            <input type="hidden" name="OrderId" value="@Model.Id" />
            <input type="hidden" name="IsBarOrder" value="@isBarOrder.ToString().ToLower()" />
            <div class="modal-header"><h5 class="modal-title">@(isBarOrder ? "Send Items To Bar" : "Send Items To Kitchen")</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body">
              <div class="mb-2 d-flex justify-content-between align-items-center">
                <span class="small text-muted">Select which un-fired items to send.</span>
                <div class="form-check form-check-sm">
                  <input type="checkbox" class="form-check-input" id="fireSelectAll" />
                  <label for="fireSelectAll" class="form-check-label small">All</label>
                </div>
              </div>
              <div class="list-group small" style="max-height:260px;overflow:auto;">
                @foreach (var ni in Model.Items.Where(i=>i.Status==0))
                {
                  <label class="list-group-item d-flex align-items-center gap-2 py-1">
                    <input type="checkbox" class="form-check-input fire-item-checkbox" value="@ni.Id" name="SelectedItems" />
                    <span class="flex-grow-1 d-flex justify-content-between align-items-center">
                      <span>@ni.MenuItemName</span>
                      <span class="badge bg-light text-dark border" style="font-weight:500;">x @ni.Quantity</span>
                    </span>
                  </label>
                }
                @if(!Model.Items.Any(i=>i.Status==0)){
                  <div class="text-muted fst-italic px-2 py-1">No pending items to fire.</div>
                }
              </div>
            </div>
            <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button><button type="submit" class="btn btn-primary"><i class="fas fa-fire"></i> Send To Kitchen</button></div>
          </form>
        </div>
      </div>
    </div>
  }
</div>

@section Scripts {
  <script src="~/js/order-modern.js"></script>
  <script>
    (function() {
      // Manage Save and Payment button states smoothly on the Order Details page
      function $(sel, ctx) { return (ctx || document).querySelector(sel); }
      function $all(sel, ctx) { return Array.from((ctx || document).querySelectorAll(sel)); }

    const saveBtn = document.getElementById('saveOrderBtn');
      const itemsBody = document.getElementById('orderItemsBody');
      const paymentBtn = document.querySelector('a[href*="/Payment/Index/"]');
  const fireBtn = document.getElementById('fireItemsBtn');
    const orderApp = document.getElementById('orderDetailsApp');
    const isFullyPaid = orderApp ? (orderApp.dataset.isFullyPaid === 'true') : false;

      function setSaveEnabled(enabled) {
        if (!saveBtn) return;
        saveBtn.disabled = !enabled;
      }

      function setPaymentEnabled(enabled) {
        if (!paymentBtn) return;
        if (enabled) {
          paymentBtn.classList.remove('btn-disabled');
          paymentBtn.removeAttribute('aria-disabled');
          paymentBtn.style.pointerEvents = '';
        } else {
          paymentBtn.classList.add('btn-disabled');
          paymentBtn.setAttribute('aria-disabled', 'true');
          paymentBtn.style.pointerEvents = 'none';
        }
      }

      function setFireEnabled(enabled) {
        if (!fireBtn) return;
        if (enabled) {
          fireBtn.classList.remove('disabled');
          fireBtn.removeAttribute('disabled');
          fireBtn.setAttribute('aria-disabled', 'false');
          fireBtn.style.pointerEvents = '';
        } else {
          fireBtn.classList.add('disabled');
          fireBtn.setAttribute('disabled', 'disabled');
          fireBtn.setAttribute('aria-disabled', 'true');
          fireBtn.style.pointerEvents = 'none';
        }
      }

      function hasSavedItems() {
        // saved items are rendered as rows with class 'existing-item-row'
        const saved = $all('#orderItemsBody tr.existing-item-row');
        return saved.length > 0;
      }

      function initState() {
        // Default: Save disabled until a change is made
        setSaveEnabled(false);
        // Payment enabled only when there are saved items
        setPaymentEnabled(hasSavedItems());
        // Fire to kitchen enabled only when there are saved items
        setFireEnabled(hasSavedItems());
        // If the order is fully paid and completed, enforce disabled UI state
        if (isFullyPaid) {
          // Disable payment and fire permanently on this view
          setPaymentEnabled(false);
          setFireEnabled(false);
          // Disable add input and button
          const menuInput = document.getElementById('menuItemInput');
          const addBtn = document.getElementById('addItemBtn');
          if (menuInput) menuInput.disabled = true;
          if (addBtn) addBtn.disabled = true;
          // Hide edit/remove controls
          document.querySelectorAll('.edit-row, .remove-existing, .save-row, .cancel-row').forEach(el => el.classList.add('d-none'));
        }
      }

      // When new rows are added or removed, enable Save (new items) or update Payment state
      if (itemsBody) {
        const mo = new MutationObserver(mutations => {
          for (const m of mutations) {
            if (m.addedNodes && m.addedNodes.length) {
              // new item(s) added -> enable Save
              setSaveEnabled(true);
            }
            if (m.removedNodes && m.removedNodes.length) {
              // an item removed -> consider enabling Save
              setSaveEnabled(true);
            }
          }
        });
        mo.observe(itemsBody, { childList: true });
      }

      // Listen for user interactions that modify rows: edits, quantity/note changes, remove
      document.addEventListener('input', function(e) {
        if (e.target && e.target.closest('#orderItemsTable')) {
          setSaveEnabled(true);
        }
      }, { passive: true });

      document.addEventListener('click', function(e) {
        if (e.target.closest && e.target.closest('#orderItemAddForm')) {
          // adding via form will be handled by mutation observer after row insertion
          return;
        }
        if (e.target.closest && e.target.closest('.edit-row')) {
          // entering edit mode -> enable Save
          setSaveEnabled(true);
        }
        if (e.target.closest && e.target.closest('.remove-existing')) {
          setSaveEnabled(true);
        }
        if (e.target && e.target.id === 'saveOrderBtn') {
          // optimistic: disable Save while saving; actual outcome will be handled by fetch proxy below
          setSaveEnabled(false);
        }
      }, true);

      // Intercept fetch so we can enable Payment when the order items save endpoint succeeds
      (function() {
        if (!window.fetch) return;
        const originalFetch = window.fetch.bind(window);
        window.fetch = async function(input, init) {
          try {
            const url = (typeof input === 'string') ? input : (input && input.url) ? input.url : '';
            const response = await originalFetch(input, init);
            // If this was the order items save endpoint and succeeded, enable Payment
            if (typeof url === 'string' && url.indexOf('/Order/UpdateMultipleOrderItems') !== -1) {
              if (response && response.ok) {
                // Saved to DB -> payment now allowed
                setPaymentEnabled(true);
                // Also enable Fire to Kitchen when items are saved
                setFireEnabled(hasSavedItems());
              } else {
                // error -> re-enable Save so user can retry
                setSaveEnabled(true);
              }
            }
            return response;
          } catch (err) {
            console.error('Fetch proxy error', err);
            throw err;
          }
        };
      })();

      // Initialize
      try { initState(); } catch (e) { console.error(e); }

      // --- Dynamic Menu Item autosuggest filtering by group ---
      const groupSelect = document.getElementById('menuItemGroupSelect');
      const dataList = document.getElementById('menuItems');
      const menuInput = document.getElementById('menuItemInput');

      async function loadMenuItemsForGroup(groupId) {
        if (!dataList) return;
        try {
          const resp = await fetch(`/Order/GetMenuItemsByGroup?groupId=${encodeURIComponent(groupId)}`);
          if (!resp.ok) return;
          const items = await resp.json();
          // Clear datalist
          dataList.innerHTML = '';
          for (const it of items) {
            const opt = document.createElement('option');
            opt.value = it.name || it.Name;
            const plu = (it.PLUCode || it.pluCode || '');
            const price = (it.Price ?? it.price ?? 0).toFixed ? (it.Price ?? it.price).toFixed(2) : (Number(it.Price ?? it.price) || 0).toFixed(2);
            opt.setAttribute('data-id', it.Id ?? it.id);
            opt.setAttribute('data-price', price);
            opt.setAttribute('data-plu', plu);
            opt.textContent = `${plu} - ${it.Name ?? it.name} (₹${price})`;
            dataList.appendChild(opt);
          }
          // Clear the current input so user sees filtered list
          if (menuInput) menuInput.value = '';
        } catch (err) {
          console.error('Failed to load menu items by group', err);
        }
      }

      if (groupSelect) {
        groupSelect.addEventListener('change', (e) => {
          const gid = e.target.value || '1';
          loadMenuItemsForGroup(gid);
        });
        // initial load on page ready (default group id=1 or selected)
        const initialGid = groupSelect.value || '1';
        loadMenuItemsForGroup(initialGid);
      }
    })();
  </script>
}
