@using RestaurantManagementSystem.Utilities
@inject Microsoft.AspNetCore.Antiforgery.IAntiforgery Antiforgery
@{
    var activeRoleName = User?.FindFirst("ActiveRoleName")?.Value;
    var requiresRoleSelection = User?.FindFirst("RoleSelectionConfirmed")?.Value == "false";
    var hasMultipleRoles = User?.FindFirst("HasMultipleRoles")?.Value == "true";
    var activeRoleId = User?.FindFirst("ActiveRoleId")?.Value;
    var antiforgeryToken = (User?.Identity?.IsAuthenticated ?? false) ? Antiforgery.GetAndStoreTokens(Context).RequestToken : null;
}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"] - RestaurantManagementSystem</title>
    @* Expose session token to client-side JS in a meta tag (only for authenticated users) *@
    @if (User?.Identity?.IsAuthenticated == true)
    {
        var sessionToken = User.FindFirst("SessionToken")?.Value;
        if (!string.IsNullOrEmpty(sessionToken))
        {
            <meta name="session-token" content="@sessionToken" />
        }
        if (!string.IsNullOrEmpty(antiforgeryToken))
        {
            <meta name="request-verification-token" content="@antiforgeryToken" />
        }
    }
    <script type="importmap"></script>
    <link rel="stylesheet" href="~/lib/bootstrap/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="~/css/site.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/RestaurantManagementSystem.styles.css" asp-append-version="true" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css" integrity="sha512-KfkfwYDsLkIlwQp6LFnl8zNdLGxu9YAA1QvwINks4PhcElQSvqcyVLLD9aMhXd13uQjoXtEKNosOWaZqXgel0g==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="~/css/datatables.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jquery-timepicker/1.13.18/jquery.timepicker.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css" />
    <link rel="stylesheet" href="~/css/settings.css" asp-append-version="true" />
    @await RenderSectionAsync("Styles", required: false)
</head>
<body data-requires-role-selection="@(requiresRoleSelection ? "true" : "false")"
    data-has-multiple-roles="@(hasMultipleRoles ? "true" : "false")"
    data-active-role-id="@(activeRoleId ?? string.Empty)">
    <style>
        /* Compact navigation styles */
        .navbar {
            padding-top: 0.25rem !important;
            padding-bottom: 0.25rem !important;
        }
        .navbar .nav-link {
            padding: 0.4rem 0.7rem !important;
            font-size: 0.85rem !important;
            font-weight: 500 !important;
        }
        
        .navbar-nav .nav-item {
            margin: 0 0.1rem;
        }
        .navbar .dropdown-menu {
            font-size: 0.9rem;
        }
        .navbar .dropdown-item {
            padding: 0.35rem 0.75rem;
        }
        
        .navbar-nav .nav-link i {
            font-size: 0.95rem;
        }
        
        .navbar-nav .dropdown-toggle::after {
            font-size: 0.7rem;
        }
        .navbar .navbar-brand {
            font-size: 1.2rem !important;
            padding-top: 0 !important;
            padding-bottom: 0 !important;
        }
        .user-menu-trigger {
            display: inline-flex;
            align-items: center;
            gap: 0.55rem;
            padding: 0.35rem 0.9rem !important;
            border-radius: 999px;
            border: 1px solid rgba(255, 255, 255, 0.15);
            background: rgba(255, 255, 255, 0.08);
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
            transition: background 0.2s ease, border-color 0.2s ease;
        }
        .user-menu-trigger:hover,
        .user-menu-trigger:focus {
            background: rgba(255, 255, 255, 0.16);
            border-color: rgba(255, 255, 255, 0.3);
        }
        .user-menu-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: linear-gradient(135deg, #ffb347, #ffcc33);
            color: #1a2a3a;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.03em;
        }
        .user-menu-details {
            display: flex;
            flex-direction: column;
            line-height: 1.1;
        }
        .user-menu-name {
            font-size: 0.78rem;
            font-weight: 600;
            text-transform: capitalize;
        }
        .user-menu-role {
            font-size: 0.65rem;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            color: #ffe8a3;
        }
        .user-menu-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #22c55e;
            box-shadow: 0 0 0 4px rgba(34, 197, 94, 0.18);
        }
        .compact-icon {
            font-size: 0.8rem;
            width: 16px;
            text-align: center;
        }
        .text-purple {
            color: #7c3aed !important;
        }
        .navbar .dropdown-toggle::after {
            vertical-align: middle;
        }
        .navbar-nav > li {
            margin-right: 3px;
        }
        footer {
            padding: 0.3rem 0.5rem !important;
            font-size: 0.85rem !important;
            min-height: 24px !important;
            line-height: 1.2 !important;
        }
        
        /* Global Hotkey Badge Styles */
        .hotkey-badge {
            background: rgba(0, 0, 0, 0.6);
            color: #fff;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 600;
            font-family: 'Courier New', monospace;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            white-space: nowrap;
        }
        
        .quick-action-btn {
            position: relative;
        }
        
    /* Ensure page main content is not hidden behind fixed navbar (update if navbar height changes) */
    /* Navbar height ~56px on desktop; increase if your brand/header is taller */
    main[role="main"] { padding-top: 56px; }
    </style>
    <header>
    <nav class="navbar navbar-expand-sm navbar-toggleable-sm navbar-dark bg-gradient mb-3 fixed-top" style="position:fixed; top:0; left:0; right:0; width:100%; background-color: #1a3c5b; border-bottom: 3px solid #f8b133; box-shadow: 0 4px 8px rgba(0,0,0,0.1); z-index:1050;">
            <div class="container-fluid">
                <div class="d-flex flex-column align-items-start brand-stack">
                    <a class="navbar-brand fw-bold mb-0" asp-area="" asp-controller="Home" asp-action="Index" style="color: #ffffff;">
                        <i class="fas fa-utensils me-1"></i>Restaurant Management
                    </a>
                    <button type="button" class="btn btn-sm btn-outline-light mt-1 py-0 px-2 d-flex align-items-center gap-1 help-trigger"
                            data-bs-toggle="modal" data-bs-target="#appHelpModal" title="Help & Shortcuts"
                            style="font-size:.65rem; line-height:1.2; border-radius:14px;">
                        <i class="fas fa-question-circle"></i> Help
                    </button>
                </div>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target=".navbar-collapse" aria-controls="navbarSupportedContent"
                        aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="navbar-collapse collapse d-sm-inline-flex justify-content-between">
                    @await Component.InvokeAsync("NavigationMenu")
                    <partial name="_LoginPartial" />
                </div>
            </div>
        </nav>
    </header>
    <div class="container d-flex flex-column flex-grow-1">
        <main role="main" class="pb-3 flex-grow-1">
            @RenderBody()
        </main>
    </div>

    <footer class="footer mt-4 py-3 bg-gradient" style="background-color: #1a3c5b; border-top: 3px solid #f8b133;">
        <div class="container">
            <div class="row">
                <div class="col-md-6 text-white">
                    <h5><i class="fas fa-utensils me-2"></i>eRestoPOS</h5>
                    <p class="small mb-0">&copy; 2025 - Sponsored & Marketed by Emeditech Plus</p>
                </div>
                <div class="col-md-6 text-end text-white">
                    <p class="mb-0">
                        <a class="text-white text-decoration-none" asp-area="" asp-controller="Home" asp-action="Privacy">Privacy Policy</a> | 
                        <a class="text-white text-decoration-none" href="#">Terms of Service</a>
                    </p>
                    <p class="small mt-1 text-white-50">Version 2.1.5</p>
                </div>
            </div>
        </div>
    </footer>
    <script src="~/lib/jquery/dist/jquery.min.js"></script>
    <script src="~/lib/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
    <script src="~/js/site.js" asp-append-version="true"></script>
    <script src="~/js/datatables.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-timepicker/1.13.18/jquery.timepicker.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
    <script>
        // Configure toastr
        toastr.options = {
            "closeButton": true,
            "progressBar": true,
            "positionClass": "toast-top-right",
            "timeOut": "5000",
            "extendedTimeOut": "2000",
            "showMethod": "fadeIn",
            "hideMethod": "fadeOut"
        };

        // Auto-display TempData messages as toastr notifications
        $(document).ready(function() {
            @if (TempData["SuccessMessage"] != null)
            {
                <text>toastr.success('@Html.Raw(TempData["SuccessMessage"])', 'Success');</text>
            }
            @if (TempData["ErrorMessage"] != null)
            {
                <text>toastr.error('@Html.Raw(TempData["ErrorMessage"])', 'Error');</text>
            }
            @if (TempData["WarningMessage"] != null)
            {
                <text>toastr.warning('@Html.Raw(TempData["WarningMessage"])', 'Warning');</text>
            }
            @if (TempData["InfoMessage"] != null)
            {
                <text>toastr.info('@Html.Raw(TempData["InfoMessage"])', 'Information');</text>
            }
        });
    </script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const body = document.body;
            const modalEl = document.getElementById('roleSelectionModal');
            if (!body || !modalEl || typeof bootstrap === 'undefined') {
                return;
            }

            const dataset = body.dataset || {};
            const hasMultipleRoles = dataset.hasMultipleRoles === 'true';
            const requiresRoleSelection = dataset.requiresRoleSelection === 'true';
            const antiforgeryMeta = document.querySelector('meta[name="request-verification-token"]');
            const antiforgeryToken = antiforgeryMeta ? antiforgeryMeta.getAttribute('content') : '';

            const controls = {
                options: modalEl.querySelector('[data-role-options]'),
                loading: modalEl.querySelector('[data-role-loading]'),
                error: modalEl.querySelector('[data-role-error]'),
                confirmBtn: modalEl.querySelector('[data-role-confirm]'),
                confirmText: modalEl.querySelector('[data-role-confirm-text]'),
                confirmSpinner: modalEl.querySelector('[data-role-confirm-spinner]'),
                closeButtons: modalEl.querySelectorAll('[data-role-close]'),
                title: modalEl.querySelector('[data-role-modal-title]'),
                description: modalEl.querySelector('[data-role-modal-description]')
            };

            const state = {
                selectedRoleId: null,
                modal: null,
                forceSelection: false
            };

            function wireSwitchRoleTriggers() {
                document.querySelectorAll('[data-role-switch-trigger]').forEach(function (trigger) {
                    trigger.addEventListener('click', function (event) {
                        event.preventDefault();
                        if (!hasMultipleRoles) {
                            return;
                        }
                        openRoleModal(false);
                    });
                });
            }

            wireSwitchRoleTriggers();

            function ensureModalInstance(forceSelection) {
                if (state.modal) {
                    state.modal.dispose();
                }
                state.modal = new bootstrap.Modal(modalEl, {
                    backdrop: forceSelection ? 'static' : true,
                    keyboard: !forceSelection
                });
                state.forceSelection = forceSelection;

                controls.closeButtons.forEach(function (btn) {
                    btn.classList.toggle('d-none', forceSelection);
                });

                if (controls.title) {
                    controls.title.textContent = forceSelection
                        ? 'Choose your role to continue'
                        : 'Switch your active role';
                }

                if (controls.description) {
                    controls.description.textContent = forceSelection
                        ? 'Please pick a role to continue working. Your dashboard will reload after confirmation.'
                        : 'Select the role you want to work in. You can switch again at any time from the profile menu.';
                }
            }

            function resetState() {
                state.selectedRoleId = null;
                if (controls.options) {
                    controls.options.innerHTML = '';
                    controls.options.classList.add('d-none');
                }
                if (controls.loading) {
                    controls.loading.classList.remove('d-none');
                }
                hideError();
                setConfirmBusy(false);
                if (controls.confirmBtn) {
                    controls.confirmBtn.disabled = true;
                }
            }

            function hideError() {
                if (controls.error) {
                    controls.error.classList.add('d-none');
                    controls.error.textContent = '';
                }
            }

            function showError(message) {
                if (controls.loading) {
                    controls.loading.classList.add('d-none');
                }
                if (controls.options) {
                    controls.options.classList.add('d-none');
                }
                if (controls.error) {
                    controls.error.textContent = message;
                    controls.error.classList.remove('d-none');
                }
                if (controls.confirmBtn) {
                    controls.confirmBtn.disabled = true;
                }
            }

            function setConfirmBusy(isBusy) {
                if (!controls.confirmBtn) {
                    return;
                }
                controls.confirmBtn.disabled = isBusy || !state.selectedRoleId;
                if (controls.confirmSpinner) {
                    controls.confirmSpinner.classList.toggle('d-none', !isBusy);
                }
                if (controls.confirmText) {
                    controls.confirmText.classList.toggle('d-none', isBusy);
                }
            }

            async function loadRoles() {
                resetState();
                try {
                    const response = await fetch('/Account/UserRoles', {
                        method: 'GET',
                        credentials: 'same-origin',
                        headers: {
                            'Accept': 'application/json'
                        }
                    });

                    if (!response.ok) {
                        throw new Error('Unable to load roles. Please try again.');
                    }

                    const payload = await response.json();
                    const roles = Array.isArray(payload) ? payload : [];
                    renderRoles(roles);
                } catch (error) {
                    const message = error && error.message ? error.message : 'Unable to load your roles right now.';
                    showError(message);
                }
            }

            function resolveRoleField(role, camelKey, pascalKey) {
                if (Object.prototype.hasOwnProperty.call(role, camelKey) && role[camelKey] !== undefined && role[camelKey] !== null) {
                    return role[camelKey];
                }
                return role[pascalKey];
            }

            function renderRoles(roles) {
                if (controls.loading) {
                    controls.loading.classList.add('d-none');
                }

                if (!roles.length) {
                    showError('No roles are assigned to this account. Please contact an administrator.');
                    return;
                }

                if (controls.options) {
                    controls.options.classList.remove('d-none');
                }

                roles.forEach(function (role) {
                    if (!controls.options) {
                        return;
                    }

                    const roleId = resolveRoleField(role, 'roleId', 'RoleId');
                    const roleName = resolveRoleField(role, 'name', 'Name') || 'Role';
                    const description = resolveRoleField(role, 'description', 'Description');
                    const isActive = Boolean(resolveRoleField(role, 'isActive', 'IsActive'));

                    const item = document.createElement('button');
                    item.type = 'button';
                    item.className = 'list-group-item list-group-item-action d-flex justify-content-between align-items-center';
                    item.dataset.roleId = roleId;
                    item.innerHTML = `
                        <div>
                            <div class="fw-semibold">${roleName}</div>
                            ${description ? `<div class="text-muted small">${description}</div>` : ''}
                        </div>
                        <span class="badge ${isActive ? 'bg-success' : 'bg-light text-dark'}">${isActive ? 'Current' : 'Select'}</span>
                    `;

                    item.addEventListener('click', function () {
                        setSelectedRole(roleId, item);
                    });

                    controls.options.appendChild(item);

                    if (isActive && !state.selectedRoleId) {
                        setSelectedRole(roleId, item, true);
                    }
                });
            }

            function setSelectedRole(roleId, button, silent) {
                state.selectedRoleId = roleId;
                if (controls.options) {
                    controls.options.querySelectorAll('.list-group-item').forEach(function (item) {
                        item.classList.remove('active');
                    });
                }
                if (button) {
                    button.classList.add('active');
                }
                if (!silent) {
                    hideError();
                }
                if (controls.confirmBtn) {
                    controls.confirmBtn.disabled = !state.selectedRoleId;
                }
            }

            async function submitRoleSelection() {
                if (!state.selectedRoleId) {
                    return;
                }

                setConfirmBusy(true);
                hideError();

                try {
                    const response = await fetch('/Account/SwitchRole', {
                        method: 'POST',
                        credentials: 'same-origin',
                        headers: {
                            'Content-Type': 'application/json',
                            'RequestVerificationToken': antiforgeryToken
                        },
                        body: JSON.stringify({ roleId: state.selectedRoleId })
                    });

                    if (!response.ok) {
                        const payload = await response.json().catch(function () { return null; });
                        const message = payload && payload.message ? payload.message : 'Unable to switch roles right now. Please try again.';
                        throw new Error(message);
                    }

                    window.location.reload();
                } catch (error) {
                    setConfirmBusy(false);
                    const message = error && error.message ? error.message : 'Unable to switch roles right now.';
                    showError(message);
                }
            }

            if (controls.confirmBtn) {
                controls.confirmBtn.addEventListener('click', submitRoleSelection);
            }

            function openRoleModal(forceSelection) {
                ensureModalInstance(forceSelection);
                state.modal.show();
                loadRoles();
            }

            if (requiresRoleSelection && hasMultipleRoles) {
                openRoleModal(true);
            }
        });
    </script>
    @await RenderSectionAsync("Scripts", required: false)

    @* Inject global help modal partial right before closing body *@
    <partial name="_HelpInfo" />

    <!-- Role Selection Modal -->
    <div class="modal fade" id="roleSelectionModal" tabindex="-1" aria-labelledby="roleSelectionModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content shadow-lg border-0">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="roleSelectionModalLabel" data-role-modal-title>Choose a role to continue</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close" data-role-close></button>
                </div>
                <div class="modal-body">
                    <p class="text-muted small mb-3" data-role-modal-description>
                        Select the role you want to use for this session. You can switch roles later from the profile menu.
                    </p>
                    <div class="alert alert-danger d-none" role="alert" data-role-error></div>
                    <div class="text-center py-4" data-role-loading>
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading roles…</span>
                        </div>
                        <div class="mt-2 text-muted small">Fetching your assigned roles</div>
                    </div>
                    <div class="list-group role-selection-options d-none" data-role-options></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal" data-role-close>Cancel</button>
                    <button type="button" class="btn btn-primary" data-role-confirm disabled>
                        <span data-role-confirm-text>Continue</span>
                        <span class="spinner-border spinner-border-sm ms-2 d-none" role="status" aria-hidden="true" data-role-confirm-spinner></span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Menu Items Modal -->
    <div class="modal fade" id="menuItemsModal" tabindex="-1" role="dialog" aria-labelledby="menuItemsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="menuItemsModalLabel">Menu Items & Estimation</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <input type="text" id="menuItemSearch" class="form-control" placeholder="Search menu items...">
                        </div>
                        <div class="col-md-4">
                            <select id="categoryFilter" class="form-control">
                                <option value="all">All Categories</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <button id="estimateBtn" class="btn btn-success w-100">Estimate</button>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table id="menuItemsTable" class="table table-striped table-hover">
                            <thead class="thead-light">
                                <tr>
                                    <th width="45%">Name</th>
                                    <th width="15%">Price</th>
                                    <th width="15%">Category</th>
                                    <th width="15%">PLU Code</th>
                                    <th width="10%">Qty</th>
                                </tr>
                            </thead>
                            <tbody id="menuItemsTableBody">
                                <tr>
                                    <td colspan="5" class="text-center">Click "Menu Items & Estimation" to load data</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="estimation-section p-3 border-top bg-light" style="display: none;">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="mb-0 text-primary">
                            <i class="fas fa-calculator me-2"></i>Order Estimation
                        </h5>
                        <small class="text-muted">All prices include GST</small>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-sm table-striped" id="estimationTable">
                            <thead class="table-primary">
                                <tr>
                                    <th width="45%">Item Description</th>
                                    <th width="20%" class="text-end">Unit Price</th>
                                    <th width="15%" class="text-center">Qty</th>
                                    <th width="20%" class="text-end">Amount</th>
                                </tr>
                            </thead>
                            <tbody id="estimationTableBody">
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer">
                    <div class="d-flex w-100 justify-content-between">
                        <div>
                            <button type="button" id="clearEstimateBtn" class="btn btn-warning me-2" style="display: none;">
                                <i class="fas fa-eraser"></i> Clear
                            </button>
                            <button type="button" id="printEstimateBtn" class="btn btn-info" style="display: none;">
                                <i class="fas fa-print"></i> Print Estimate
                            </button>
                        </div>
                        <div>
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        $(document).ready(function() {
            // Initialize Menu Items Modal functionality for navigation
            $('#menuItemsNavBtn').click(function() {
                loadMenuItemsInModal();
                var menuModal = new bootstrap.Modal(document.getElementById('menuItemsModal'));
                menuModal.show();
                
                // Reset estimation section
                $('.estimation-section').hide();
                $('#printEstimateBtn').hide();
                $('#clearEstimateBtn').hide();
                $('#estimationTableBody').empty();
            });
            
            // Menu Items search functionality
            $('#menuItemSearch').on('keyup', function() {
                var searchText = $(this).val().toLowerCase();
                $('#menuItemsTable tbody tr').filter(function() {
                    $(this).toggle($(this).text().toLowerCase().indexOf(searchText) > -1);
                });
            });
            
            // Category filter functionality
            $('#categoryFilter').on('change', function() {
                var category = $(this).val().toLowerCase();
                if (category === 'all') {
                    $('#menuItemsTable tbody tr').show();
                } else {
                    $('#menuItemsTable tbody tr').filter(function() {
                        $(this).toggle($(this).find('td:eq(2)').text().toLowerCase() === category);
                    });
                }
            });
            
            // Estimate button functionality
            $('#estimateBtn').on('click', function() {
                generateMenuEstimate();
            });
            
            // Print estimate button functionality
            $('#printEstimateBtn').on('click', function() {
                printMenuEstimate();
            });
            
            // Clear estimate button functionality
            $('#clearEstimateBtn').on('click', function() {
                clearMenuEstimate();
            });
            
            // Watch for quantity input changes
            $(document).on('change', '.qty-input', function() {
                var value = parseInt($(this).val());
                if (isNaN(value) || value < 0) {
                    $(this).val(0);
                }
            });
            
            function loadMenuItemsInModal() {
                // Show loading indicator
                $('#menuItemsTableBody').html('<tr><td colspan="5" class="text-center">Loading menu items...</td></tr>');
                
                // Fetch menu items from API
                $.ajax({
                    url: '/Menu/Index',
                    method: 'GET',
                    success: function(data) {
                        // Extract menu items from the response
                        var menuItems = $(data).find('.table tbody tr');
                        var tableBody = $('#menuItemsTableBody');
                        
                        if (menuItems.length > 0) {
                            tableBody.empty();
                            
                            // Process and add menu items to modal table
                            menuItems.each(function() {
                                var pluCode = $(this).find('td:eq(0)').text().trim();
                                var name = $(this).find('td:eq(2)').text().trim();
                                var category = $(this).find('td:eq(3)').text().trim();
                                // Menu Index columns: 0=PLU,1=Image,2=Name,3=Category,4=SubCategory,5=Price
                                var price = $(this).find('td:eq(5)').text().trim();
                                
                                // Extract numeric price value
                                // Extract numeric price value robustly (handles currency symbols and words)
                                var numericPriceMatch = price.match(/([0-9]+([.,][0-9]+)?)/);
                                var numericPrice = numericPriceMatch ? numericPriceMatch[0].replace(',', '') : '';
                                
                                tableBody.append(`
                                    <tr data-price="${numericPrice}">
                                        <td>${name}</td>
                                        <td>${price}</td>
                                        <td>${category}</td>
                                        <td>${pluCode}</td>
                                        <td>
                                            <input type="number" class="form-control form-control-sm qty-input" min="0" value="0" step="1">
                                        </td>
                                    </tr>
                                `);
                                
                                // Add category to filter if not already present
                                if ($('#categoryFilter option[value="' + category.toLowerCase() + '"]').length === 0) {
                                    $('#categoryFilter').append(`<option value="${category.toLowerCase()}">${category}</option>`);
                                }
                            });
                        } else {
                            tableBody.html('<tr><td colspan="5" class="text-center">No menu items found</td></tr>');
                        }
                    },
                    error: function() {
                        $('#menuItemsTableBody').html('<tr><td colspan="5" class="text-center text-danger">Error loading menu items</td></tr>');
                    }
                });
            }
            
            // Function to generate estimate
            function generateMenuEstimate() {
                var selectedItems = [];
                var total = 0;
                var hasSelectedItems = false;
                
                // Collect all items with quantity > 0
                $('#menuItemsTable tbody tr').each(function() {
                    var qtyInput = $(this).find('.qty-input');
                    var qty = parseInt(qtyInput.val());
                    
                    if (qty > 0) {
                        var name = $(this).find('td:eq(0)').text().trim();
                        var priceText = $(this).find('td:eq(1)').text().trim();
                        var dataPrice = $(this).data('price');
                        
                        // Use data-price attribute if available, otherwise parse the text
                        var price = parseFloat(dataPrice) || parseFloat(priceText.replace(/[^\d.]/g, ''));
                        
                        if (!isNaN(price) && price > 0) {
                            var subtotal = qty * price;
                            
                            selectedItems.push({
                                name: name,
                                price: price,
                                qty: qty,
                                subtotal: subtotal
                            });
                            
                            total += subtotal;
                            hasSelectedItems = true;
                        }
                    }
                });
                
                // Update estimation table
                var estimationBody = $('#estimationTableBody');
                estimationBody.empty();
                
                if (hasSelectedItems) {
                    selectedItems.forEach(function(item) {
                        estimationBody.append(`
                            <tr>
                                <td class="fw-bold">${item.name}</td>
                                <td class="text-end">₹${item.price.toFixed(2)}</td>
                                <td class="text-center">${item.qty}</td>
                                <td class="text-end fw-bold">₹${item.subtotal.toFixed(2)}</td>
                            </tr>
                        `);
                    });
                    
                    // No GST displayed in estimation widget — show subtotal and grand total equal to subtotal
                    var tax = 0.00;
                    var grandTotal = total;

                    estimationBody.append(`
                        <tr class="border-top">
                            <td colspan="3" class="text-end fw-bold">Subtotal:</td>
                            <td class="text-end fw-bold">₹${total.toFixed(2)}</td>
                        </tr>
                        <tr class="table-success">
                            <td colspan="3" class="text-end fw-bold fs-5">Grand Total:</td>
                            <td class="text-end fw-bold fs-5">₹${grandTotal.toFixed(2)}</td>
                        </tr>
                    `);
                    
                    // Show estimation section and buttons
                    $('.estimation-section').show();
                    $('#printEstimateBtn').show();
                    $('#clearEstimateBtn').show();
                    
                    // Success message
                    showMenuToast('Estimate generated successfully!', 'success');
                } else {
                    // No items selected
                    estimationBody.append(`
                        <tr>
                            <td colspan="4" class="text-center text-muted py-4">
                                <i class="fas fa-shopping-cart me-2"></i>
                                Please select items and quantities to generate an estimate
                            </td>
                        </tr>
                    `);
                    $('.estimation-section').show();
                    $('#printEstimateBtn').hide();
                    $('#clearEstimateBtn').hide();
                    
                    // Warning message
                    showMenuToast('Please select items and enter quantities to generate estimate', 'warning');
                }
            }
            
            // Function to print estimate
            function printMenuEstimate() {
                var currentDate = new Date();
                var estimateNumber = 'EST-' + currentDate.getFullYear() + (currentDate.getMonth() + 1).toString().padStart(2, '0') + currentDate.getDate().toString().padStart(2, '0') + '-' + Math.floor(Math.random() * 1000);
                
                var printContents = `
                    <html>
                    <head>
                        <title>Order Estimate - ${estimateNumber}</title>
                        <style>
                            body { 
                                font-family: Arial, sans-serif; 
                                margin: 20px;
                                line-height: 1.4;
                            }
                            .header { 
                                text-align: center; 
                                margin-bottom: 30px;
                                border-bottom: 2px solid #007bff;
                                padding-bottom: 15px;
                            }
                            .company-name {
                                font-size: 24px;
                                font-weight: bold;
                                color: #007bff;
                                margin-bottom: 5px;
                            }
                            .estimate-title {
                                font-size: 18px;
                                color: #333;
                                margin-bottom: 10px;
                            }
                            .estimate-info {
                                display: flex;
                                justify-content: space-between;
                                margin-bottom: 20px;
                                font-size: 14px;
                            }
                            table { 
                                width: 100%; 
                                border-collapse: collapse;
                                margin-bottom: 20px;
                            }
                            th, td { 
                                border: 1px solid #ddd; 
                                padding: 12px 8px; 
                                text-align: left; 
                            }
                            th { 
                                background-color: #f8f9fa;
                                font-weight: bold;
                                color: #333;
                            }
                            .text-right { text-align: right; }
                            .text-center { text-align: center; }
                            .total-row { 
                                background-color: #e8f5e8;
                                font-weight: bold;
                            }
                            .footer { 
                                margin-top: 30px; 
                                text-align: center; 
                                font-style: italic;
                                color: #666;
                                border-top: 1px solid #ddd;
                                padding-top: 15px;
                            }
                            .terms {
                                margin-top: 20px;
                                font-size: 12px;
                                color: #666;
                            }
                        </style>
                    </head>
                    <body>
                        <div class="header">
                            <div class="company-name">Restaurant Management System</div>
                            <div class="estimate-title">ORDER ESTIMATE</div>
                        </div>
                        
                        <div class="estimate-info">
                            <div>
                                <strong>Estimate #:</strong> ${estimateNumber}<br>
                                <strong>Date:</strong> ${currentDate.toLocaleDateString('en-IN')}<br>
                                <strong>Time:</strong> ${currentDate.toLocaleTimeString('en-IN')}
                            </div>
                            <div>
                                <strong>Valid Until:</strong> ${new Date(currentDate.getTime() + 7*24*60*60*1000).toLocaleDateString('en-IN')}<br>
                                <strong>Prepared By:</strong> System User
                            </div>
                        </div>
                        
                        <table>
                            <thead>
                                <tr>
                                    <th style="width: 50%;">Item Description</th>
                                    <th style="width: 15%;" class="text-right">Unit Price</th>
                                    <th style="width: 10%;" class="text-center">Qty</th>
                                    <th style="width: 15%;" class="text-right">Amount</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                // Add all rows from the estimation table
                $('#estimationTableBody tr').each(function() {
                    if ($(this).find('td').length === 4) {
                        var cells = $(this).find('td');
                        var isTotal = $(this).hasClass('table-success') || $(this).find('td:first').text().includes('Grand Total');
                        var rowClass = isTotal ? 'total-row' : '';
                        
                        printContents += `<tr class="${rowClass}">`;
                        cells.each(function(index) {
                            var cellClass = '';
                            if (index === 1 || index === 3) cellClass = 'text-right';
                            if (index === 2) cellClass = 'text-center';
                            
                            printContents += `<td class="${cellClass}">${$(this).text()}</td>`;
                        });
                        printContents += '</tr>';
                    }
                });
                
                printContents += `
                            </tbody>
                        </table>
                        
                        <div class="terms">
                            <strong>Terms & Conditions:</strong><br>
                            1. This is an estimate only. Final prices may vary.<br>
                            2. Prices are subject to change without notice.<br>
                            3. All prices include applicable taxes.<br>
                            4. This estimate is valid for 7 days from the date of issue.
                        </div>
                        
                        <div class="footer">
                            <p><strong>Thank you for choosing our restaurant!</strong></p>
                            <p>For any queries, please contact our management team.</p>
                        </div>
                    </body>
                    </html>
                `;
                
                // Create a new window for printing
                var printWindow = window.open('', '_blank', 'width=800,height=600');
                printWindow.document.write(printContents);
                printWindow.document.close();
                printWindow.focus();
                
                // Print after a short delay to ensure content is loaded
                setTimeout(function() {
                    printWindow.print();
                }, 500);
                
                showMenuToast('Estimate prepared for printing', 'success');
            }
            
            // Function to clear estimate
            function clearMenuEstimate() {
                // Reset all quantity inputs to 0
                $('.qty-input').val(0);
                
                // Clear estimation table
                $('#estimationTableBody').empty();
                
                // Hide estimation section and buttons
                $('.estimation-section').hide();
                $('#printEstimateBtn').hide();
                $('#clearEstimateBtn').hide();
                
                showMenuToast('Estimate cleared successfully', 'info');
            }
            
            // Toast notification function
            function showMenuToast(message, type = 'info') {
                // Remove existing toasts
                $('.toast-notification').remove();
                
                var bgClass = 'bg-info';
                var icon = 'fa-info-circle';
                
                switch(type) {
                    case 'success':
                        bgClass = 'bg-success';
                        icon = 'fa-check-circle';
                        break;
                    case 'warning':
                        bgClass = 'bg-warning';
                        icon = 'fa-exclamation-triangle';
                        break;
                    case 'error':
                        bgClass = 'bg-danger';
                        icon = 'fa-times-circle';
                        break;
                }
                
                var toast = $(`
                    <div class="toast-notification position-fixed top-0 end-0 m-3 ${bgClass} text-white p-3 rounded shadow" style="z-index: 9999;">
                        <i class="fas ${icon} me-2"></i>${message}
                    </div>
                `);
                
                $('body').append(toast);
                
                // Auto-hide after 3 seconds
                setTimeout(function() {
                    toast.fadeOut(300, function() {
                        $(this).remove();
                    });
                }, 3000);
            }
        });
    </script>
    <script>
        // If a session token meta is present, fetch public IP and POST to server to update session record
        (function() {
            try {
                var meta = document.querySelector('meta[name="session-token"]');
                if (!meta) return; // no session token available

                var token = meta.getAttribute('content');
                if (!token) return;

                // Fetch public IP from ipify (simple, reliable)
                fetch('https://api.ipify.org?format=json')
                    .then(function(resp) { return resp.json(); })
                    .then(function(data) {
                        var ip = data && data.ip ? data.ip : null;
                        if (!ip) return;

                        // Post to server endpoint to update session ip
                        var formData = new FormData();
                        formData.append('token', token);
                        formData.append('ip', ip);

                        fetch('/Account/ReportClientIp', {
                            method: 'POST',
                            body: formData,
                            credentials: 'same-origin'
                        }).then(function(res) {
                            // optional: log success/failure to console for debugging
                            if (!res.ok) console.debug('Failed to report client IP', res.status);
                        }).catch(function(err) {
                            console.debug('Error reporting client IP', err);
                        });
                    })
                    .catch(function(err) {
                        console.debug('Error fetching public IP', err);
                    });
            } catch (e) {
                console.debug('Exception in client IP reporter', e);
            }
        })();
    </script>

    <!-- Global Hotkey System -->
    <script>
        // Simple, working hotkey system
        document.addEventListener('DOMContentLoaded', function() {
            // Lightweight toast notification for hotkeys
            function showHotkey(message) {
                let container = document.getElementById('hotkeyToastContainer');
                if (!container) {
                    container = document.createElement('div');
                    container.id = 'hotkeyToastContainer';
                    container.style.position = 'fixed';
                    container.style.top = '12px';
                    container.style.right = '12px';
                    container.style.zIndex = '10000';
                    container.style.display = 'flex';
                    container.style.flexDirection = 'column';
                    container.style.gap = '8px';
                    document.body.appendChild(container);
                }
                const toast = document.createElement('div');
                toast.textContent = message;
                toast.style.background = 'rgba(20,184,166,0.95)';
                toast.style.color = '#fff';
                toast.style.padding = '8px 14px';
                toast.style.fontSize = '13px';
                toast.style.borderRadius = '6px';
                toast.style.boxShadow = '0 2px 6px rgba(0,0,0,.25)';
                toast.style.fontWeight = '500';
                toast.style.opacity = '0';
                toast.style.transform = 'translateX(15px)';
                toast.style.transition = 'opacity .15s ease, transform .15s ease';
                container.appendChild(toast);
                requestAnimationFrame(() => {
                    toast.style.opacity = '1';
                    toast.style.transform = 'translateX(0)';
                });
                setTimeout(() => {
                    toast.style.opacity = '0';
                    toast.style.transform = 'translateX(15px)';
                    setTimeout(() => toast.remove(), 180);
                }, 2200);
            }
            
            // Navigation functions
            function navigateTo(url) {
                window.location.href = url;
            }
            
            function getCurrentPage() {
                const path = window.location.pathname.toLowerCase();
                if (path === '/' || path === '/home' || path.includes('/home/index')) return 'home';
                if (path.includes('/order/create')) return 'order-create';
                if (path.includes('/order/details')) return 'order-details';
                if (path.includes('/bot/barordercreate')) return 'bar-order-create';
                if (path.includes('/bot/details')) return 'bar-order-details';
                if (path.includes('/payment/index')) return 'payment-index';
                if (path.includes('/kitchen/dashboard')) return 'kitchen-dashboard';
                if (path.includes('/tableservice/dashboard')) return 'table-dashboard';
                if (path.includes('/bot/barorderdashboard')) return 'bar-dashboard';
                return 'unknown';
            }
            
            // Main keydown handler
            document.addEventListener('keydown', function(e) {
                // Skip if typing in input fields (except space bar)
                const isInput = e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.isContentEditable;
                if (isInput && e.key !== ' ') return;
                
                const ctrl = e.ctrlKey || e.metaKey;
                const shift = e.shiftKey;
                const key = e.key.toLowerCase();
                const page = getCurrentPage();
                
                // Shift+F - Food Order (from home)
                if (shift && !ctrl && key === 'f' && page === 'home') {
                    e.preventDefault();
                    showHotkey('Food Order (Shift+F)');
                    navigateTo('/Order/Create');
                    return;
                }
                
                // Shift+B - BAR Order (from home)
                if (shift && !ctrl && key === 'b' && page === 'home') {
                    e.preventDefault();
                    showHotkey('BAR Order (Shift+B)');
                    navigateTo('/BOT/BarOrderCreate');
                    return;
                }
                
                // Shift+K - Kitchen Dashboard (from home)
                if (shift && !ctrl && key === 'k' && page === 'home') {
                    e.preventDefault();
                    showHotkey('Kitchen Dashboard (Shift+K)');
                    navigateTo('/Kitchen/Dashboard');
                    return;
                }
                
                // Shift+T - Table Dashboard (from home)
                if (shift && !ctrl && key === 't' && page === 'home') {
                    e.preventDefault();
                    showHotkey('Table Dashboard (Shift+T)');
                    navigateTo('/TableService/Dashboard');
                    return;
                }
                
                // Ctrl+O - Create Order (on order create pages)
                if (ctrl && !shift && key === 'o') {
                    if (page === 'order-create' || page === 'bar-order-create') {
                        e.preventDefault();
                        e.stopPropagation();
                        e.stopImmediatePropagation();
                        showHotkey(page === 'bar-order-create' ? 'Submitting BAR Order (Ctrl+O)' : 'Submitting Order (Ctrl+O)');
                        const form = document.querySelector('form');
                        if (form) form.submit();
                    }
                    return true; // Always prevent browser default
                }
                
                // Ctrl+S - Save Order (on order details pages)
                if (ctrl && !shift && key === 's') {
                    if (page === 'order-details' || page === 'bar-order-details') {
                        e.preventDefault();
                        const saveBtn = document.getElementById('saveOrderBtn');
                        if (saveBtn && !saveBtn.disabled) saveBtn.click();
                        showHotkey('Saving Order (Ctrl+S)');
                    }
                    return;
                }
                
                // Ctrl+F - Fire to Kitchen/Bar (on order details pages)
                if (ctrl && !shift && key === 'f') {
                    if (page === 'order-details' || page === 'bar-order-details') {
                        e.preventDefault();
                        const fireBtn = document.getElementById('fireItemsBtn');
                        if (fireBtn && !fireBtn.disabled) fireBtn.click();
                        showHotkey('Firing Items (Ctrl+F)');
                    }
                    return;
                }
                
                // Ctrl+P - Payment (on order details or payment pages)
                if (ctrl && !shift && key === 'p') {
                    if (page === 'order-details' || page === 'bar-order-details') {
                        e.preventDefault();
                        const paymentLink = document.querySelector('a[href*="/Payment/Index/"]');
                        if (paymentLink && !paymentLink.classList.contains('btn-disabled')) {
                            showHotkey('Opening Payment (Ctrl+P)');
                            paymentLink.click();
                        }
                    } else if (page === 'payment-index') {
                        e.preventDefault();
                        const processLink = document.getElementById('processPaymentLink');
                        if (processLink && !processLink.classList.contains('disabled')) {
                            showHotkey('Processing Payment (Ctrl+P)');
                            processLink.click();
                        }
                    }
                    return;
                }
                
                // Shift+P - Print Bill (on payment index)
                if (shift && !ctrl && key === 'p' && page === 'payment-index') {
                    e.preventDefault();
                    const printBtn = document.getElementById('printPOSBillBtn');
                    if (printBtn && !printBtn.disabled) printBtn.click();
                    showHotkey('Printing Bill (Shift+P)');
                    return;
                }
                
                // Space - Focus Menu Item (on order details pages)
                if (key === ' ' && !ctrl && !shift && !isInput) {
                    if (page === 'order-details' || page === 'bar-order-details') {
                        e.preventDefault();
                        const menuInput = document.getElementById('menuItemInput');
                        if (menuInput && !menuInput.disabled) {
                            menuInput.focus();
                            menuInput.click();
                            showHotkey('Menu Search (Space)');
                        }
                    }
                    return;
                }
            }, true);
            
            console.log('✅ Hotkey system loaded successfully');
        });
    </script>
</body>
</html>
